name: API Build (Artifact Only)
# NOTE: Environment deployments are centralized in promote-release.yml.
# This workflow builds and packages api.zip only (build or manual seed to a release tag).

on:
  workflow_call:
    inputs:
      git_ref:
        description: 'Tag or commit SHA (empty = HEAD)'
        required: false
        type: string
        default: ''
      release_tag:
        description: 'Optional: Release tag (e.g., v1.2.3). If set, builds api.zip and attaches to that tag (seed).'
        required: false
        type: string
        default: ''
      allow_override:
        description: 'Allow replacing existing api.zip on the release (only when not LOCKED)'
        type: boolean
        required: false
        default: false
      unit_test_project:
        description: 'Path to unit test project (e.g., tests/Ems.UnitTests/Ems.UnitTests.csproj)'
        required: true
        type: string
        
      api_project:
        description: 'Path to API project csproj (e.g., backend/src/Ems.Api/Ems.Api.csproj)'
        required: true
        type: string
        
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      git_ref:
        description: 'Tag or commit SHA (empty = HEAD)'
        required: false
        default: ''
      release_tag:
        description: 'Optional: Release tag (e.g., v1.2.3). If set, builds api.zip and attaches to that tag (seed).'
        required: false
        default: ''
      allow_override:
        description: 'Allow replacing existing api.zip on the release (only when not LOCKED)'
        type: boolean
        required: false
        default: false
      unit_test_project:
        description: 'Path to unit test project (e.g., tests/Ems.UnitTests/Ems.UnitTests.csproj)'
        required: true
        type: string
        
      api_project:
        description: 'Path to API project csproj (e.g., backend/src/Ems.Api/Ems.Api.csproj)'
        required: true
        type: string
        
  # All automated triggers are orchestrated from main-verify.yml via workflow_dispatch

permissions:
  id-token: write
  contents: write

concurrency:
  # Single build concurrency group; environment deployments moved to promote-release.yml
  group: tems-api-build
  cancel-in-progress: true

jobs:
  # Note: Environment deploy steps removed. Use promote-release.yml for dev/uat/preprod/prod.

  build-test-deploy:
    name: Build & Package
    runs-on: ubuntu-latest
    # Build for tag pushes (to create durable release assets) OR any manual run
    if: (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) || github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call'
    env:
      PACKAGE: api.zip
      BRANCH_NAME: "${{ github.ref_name || github.event.repository.default_branch || 'main' }}"
      DEFAULT_BRANCH: "${{ github.event.repository.default_branch || 'main' }}"
    outputs:
      version: ${{ steps.derive_version.outputs.version }}
    steps:
      - name: Debug trigger context
        if: always()
        shell: bash
        run: |
          echo "Event:               ${{ github.event_name }}"
          echo "Repo default_branch: ${{ github.event.repository.default_branch }}"
          echo "Ref:                 ${{ github.ref }}"
          echo "Inputs.release_tag:  ${{ inputs.release_tag }}"
          echo ""
          echo "Expected behavior:"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.release_tag }}" ]; then
            echo "✓ SEED MODE: Will build api.zip and attach to release ${{ inputs.release_tag }}"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "✓ BUILD MODE: Will build api.zip as workflow artifact (no release attachment)"
          elif [ "${{ github.event_name }}" = "push" ]; then
            echo "✓ TAG BUILD: Will build and attach to this tag"
          else
            echo "✓ DEPLOY MODE: Will download from release and deploy"
          fi

      - name: Checkout repository (no token persisted)
        if: github.event_name != 'pull_request'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.git_ref || '' }}
          persist-credentials: false

      - uses: actions/setup-dotnet@v4
        with: { dotnet-version: '10.0.x' }

      - name: Derive version
        id: derive_version
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ github.ref_type }}" = "tag" ]; then
            VERSION="${{ github.ref_name }}"
          elif [ -n "${{ inputs.release_tag }}" ]; then
            VERSION="${{ inputs.release_tag }}"
          else
            VERSION="0.0.0-dev"
          fi
          # Strip 'v' prefix if present (v0.1.0 → 0.1.0)
          VERSION="${VERSION#v}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Derived version: $VERSION"

      - name: Detect SonarCloud settings
        id: sonar
        uses: ./.github/actions/sonar-detect
        with:
          requested: true
          token: ${{ secrets.SONAR_TOKEN }}
          org: ${{ secrets.SONAR_ORG }}
          projectKey: ${{ secrets.SONAR_PROJECT_KEY }}


      - name: Determine seed mode
        id: mode
        shell: bash
        env:
          RELEASE_TAG: ${{ inputs.release_tag }}
          EV: ${{ github.event_name }}
        run: |
          set -euo pipefail
          if { [ "$EV" = "workflow_dispatch" ] || [ "$EV" = "workflow_call" ]; } && [ -n "${RELEASE_TAG:-}" ]; then
            echo "mode=seed" >> $GITHUB_OUTPUT
            echo "attach_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
            echo "Seed mode (build + attach to $RELEASE_TAG)" >> $GITHUB_STEP_SUMMARY
          else
            echo "mode=build" >> $GITHUB_OUTPUT
            echo "Build mode (artifact only)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Restore
        if: steps.mode.outputs.mode == 'build' || steps.mode.outputs.mode == 'seed'
        run: dotnet restore TEMS.sln

      - name: SonarCloud Begin (build)
        if: (steps.mode.outputs.mode == 'build' || steps.mode.outputs.mode == 'seed') && steps.sonar.outputs.enabled == 'true' && env.BRANCH_NAME == env.DEFAULT_BRANCH
        uses: ./.github/actions/sonar-dotnet-begin
        with:
          token: ${{ secrets.SONAR_TOKEN }}
          org: ${{ secrets.SONAR_ORG }}
          projectKey: ${{ secrets.SONAR_PROJECT_KEY }}
          

      - name: Build
        if: steps.mode.outputs.mode == 'build' || steps.mode.outputs.mode == 'seed'
        run: dotnet build TEMS.sln -c Release --no-restore

      - name: Unit Tests + Coverage
        if: steps.mode.outputs.mode == 'build' || steps.mode.outputs.mode == 'seed'
        run: |
          dotnet test ${{ inputs.unit_test_project || 'tests/Ems.UnitTests/Ems.UnitTests.csproj' }} \
            -c Release --no-build \
            --collect:"XPlat Code Coverage" \
            --logger "trx;LogFileName=unit.trx" \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura
          dotnet tool install -g dotnet-reportgenerator-globaltool || true
          reportgenerator -reports:**/coverage.cobertura.xml -targetdir:coverage-report -reporttypes:TextSummary
          cat coverage-report/Summary.txt

      - name: SonarCloud End (build)
        # Make non-blocking; only run on default branch builds
        if: (steps.mode.outputs.mode == 'build' || steps.mode.outputs.mode == 'seed') && steps.sonar.outputs.enabled == 'true' && env.BRANCH_NAME == env.DEFAULT_BRANCH
        continue-on-error: true
        uses: ./.github/actions/sonar-dotnet-end
        with:
          token: ${{ secrets.SONAR_TOKEN }}

      - name: Publish API (zip)
        if: steps.mode.outputs.mode == 'build' || steps.mode.outputs.mode == 'seed'
        run: |
          dotnet publish ${{ inputs.api_project || 'backend/src/Ems.Api/Ems.Api.csproj' }} \
            -c Release -o ./publish \
            -p:InformationalVersion="${VERSION}" -p:Version="0.0.0"
          cd publish
          zip -r "../$PACKAGE" .
          cd ..

      - name: Upload API package artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-package
          path: ${{ env.PACKAGE }}
          if-no-files-found: warn
          retention-days: 7

      - name: Upload test results and coverage
        if: steps.mode.outputs.mode == 'build' || steps.mode.outputs.mode == 'seed'
        uses: actions/upload-artifact@v4
        with:
          name: api-tests-and-coverage
          path: |
            **/TestResults/**
            coverage-report/**
            **/coverage.cobertura.xml
          if-no-files-found: warn
          retention-days: 7

      - name: Package API tests (archive)
        if: steps.mode.outputs.mode == 'build' || steps.mode.outputs.mode == 'seed'
        shell: bash
        run: |
          set -euo pipefail
          rm -f api-tests.zip || true
          zip -r api-tests.zip $(dirname ${{ inputs.unit_test_project || 'tests/Ems.UnitTests/Ems.UnitTests.csproj' }}) -x "**/bin/**" "**/obj/**"

      - name: Attach api-tests.zip to Release (tag build)
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.derive_version.outputs.version }}
          name: ${{ steps.derive_version.outputs.version }}
          files: api-tests.zip
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Attach api.zip to Release (tag build)
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.derive_version.outputs.version }}
          name: ${{ steps.derive_version.outputs.version }}
          files: ${{ env.PACKAGE }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Inspect release state (seed)
        if: (github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call') && inputs.release_tag != '' && steps.mode.outputs.mode == 'seed'
        id: rel
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ inputs.release_tag }}
        run: |
          set -euo pipefail
          api="https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/tags/${TAG}"
          json=$(curl -s -H "Authorization: token $GH_TOKEN" "$api")
          body=$(echo "$json" | jq -r '.body // ""')
          if echo "$body" | grep -q '<!-- LOCKED -->'; then echo "locked=true" >> $GITHUB_OUTPUT; else echo "locked=false" >> $GITHUB_OUTPUT; fi
          id=$(echo "$json" | jq -r '.assets[] | select(.name=="api.zip") | .id' | head -n1)
          if [ -n "$id" ] && [ "$id" != "null" ]; then echo "has_asset=true" >> $GITHUB_OUTPUT; echo "asset_id=$id" >> $GITHUB_OUTPUT; else echo "has_asset=false" >> $GITHUB_OUTPUT; fi
          id2=$(echo "$json" | jq -r '.assets[] | select(.name=="api-tests.zip") | .id' | head -n1)
          if [ -n "$id2" ] && [ "$id2" != "null" ]; then echo "has_tests=true" >> $GITHUB_OUTPUT; echo "tests_asset_id=$id2" >> $GITHUB_OUTPUT; else echo "has_tests=false" >> $GITHUB_OUTPUT; fi

      - name: Delete existing api.zip (override)
        if: (github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call') && inputs.release_tag != '' && steps.mode.outputs.mode == 'seed' && inputs.allow_override == true && steps.rel.outputs.locked != 'true' && steps.rel.outputs.has_asset == 'true'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ASSET_ID: ${{ steps.rel.outputs.asset_id }}
        run: |
          set -euo pipefail
          curl -s -X DELETE -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/assets/${ASSET_ID}" | cat

      - name: Delete existing api-tests.zip (override)
        if: (github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call') && inputs.release_tag != '' && steps.mode.outputs.mode == 'seed' && inputs.allow_override == true && steps.rel.outputs.locked != 'true' && steps.rel.outputs.has_tests == 'true'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ASSET_ID: ${{ steps.rel.outputs.tests_asset_id }}
        run: |
          set -euo pipefail
          curl -s -X DELETE -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/assets/${ASSET_ID}" | cat

      - name: Attach api.zip to Release (manual seed)
        if: (github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call') && inputs.release_tag != '' && steps.mode.outputs.mode == 'seed' && steps.rel.outputs.locked != 'true'
        continue-on-error: true
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.release_tag }}
          name: ${{ inputs.release_tag }}
          files: ${{ env.PACKAGE }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Attach api-tests.zip to Release (manual seed)
        if: (github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call') && inputs.release_tag != '' && steps.mode.outputs.mode == 'seed' && steps.rel.outputs.locked != 'true'
        continue-on-error: true
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.release_tag }}
          name: ${{ inputs.release_tag }}
          files: api-tests.zip
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fallback attach via GitHub API (if missing)
        if: (github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call') && inputs.release_tag != '' && steps.mode.outputs.mode == 'seed' && steps.rel.outputs.locked != 'true'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ inputs.release_tag }}
          FILE: ${{ env.PACKAGE }}
        run: |
          set -euo pipefail
          api="https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/tags/${TAG}"
          json=$(curl -s -H "Authorization: token $GH_TOKEN" "$api")
          # Check if asset already present
          names=$(echo "$json" | jq -r '.assets[].name // empty')
          if echo "$names" | grep -qx 'api.zip'; then
            echo "api.zip already present on $TAG; skipping fallback upload."
            exit 0
          fi
          upload_url=$(echo "$json" | jq -r '.upload_url' | sed 's/{?name,label}//')
          if [ -z "$upload_url" ] || [ "$upload_url" = "null" ]; then
            echo "Unable to resolve upload_url for $TAG" >&2
            exit 1
          fi
          echo "Uploading api.zip via REST API..."
          curl -s -X POST -H "Authorization: token $GH_TOKEN" \
               -H "Content-Type: application/zip" \
               --data-binary @"$FILE" \
               "$upload_url?name=api.zip" >/dev/null
          # verify
          json2=$(curl -s -H "Authorization: token $GH_TOKEN" "$api")
          names2=$(echo "$json2" | jq -r '.assets[].name // empty')
          if echo "$names2" | grep -qx 'api.zip'; then
            echo "api.zip attached successfully via fallback."
          else
            echo "Fallback upload did not attach api.zip" >&2
            exit 1
          fi

      - name: Fallback attach api-tests.zip via GitHub API (if missing)
        if: (github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call') && inputs.release_tag != '' && steps.mode.outputs.mode == 'seed' && steps.rel.outputs.locked != 'true'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ inputs.release_tag }}
        run: |
          set -euo pipefail
          api="https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/tags/${TAG}"
          json=$(curl -s -H "Authorization: token $GH_TOKEN" "$api")
          names=$(echo "$json" | jq -r '.assets[].name // empty')
          if echo "$names" | grep -qx 'api-tests.zip'; then
            echo "api-tests.zip already present on $TAG; skipping fallback upload."
            exit 0
          fi
          upload_url=$(echo "$json" | jq -r '.upload_url' | sed 's/{?name,label}//')
          if [ -z "$upload_url" ] || [ "$upload_url" = "null" ]; then
            echo "Unable to resolve upload_url for $TAG" >&2
            exit 1
          fi
          echo "Uploading api-tests.zip via REST API..."
          curl -s -X POST -H "Authorization: token $GH_TOKEN" \
               -H "Content-Type: application/zip" \
               --data-binary @"api-tests.zip" \
               "$upload_url?name=api-tests.zip" >/dev/null
          # verify
          json2=$(curl -s -H "Authorization: token $GH_TOKEN" "$api")
          names2=$(echo "$json2" | jq -r '.assets[].name // empty')
          if echo "$names2" | grep -qx 'api-tests.zip'; then
            echo "api-tests.zip attached successfully via fallback."
          else
            echo "Fallback upload did not attach api-tests.zip" >&2
            exit 1
          fi

      - name: Verify api.zip uploaded to Release (manual seed)
        if: (github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call') && inputs.release_tag != '' && steps.mode.outputs.mode == 'seed'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ inputs.release_tag }}
        run: |
          set -euo pipefail
          assets=$(curl -s -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/tags/${TAG}" | jq -r '.assets[].name // empty')
          echo "Assets on ${TAG}:"; echo "$assets" | sed 's/^/- /'
          if echo "$assets" | grep -qx 'api.zip'; then
            echo "✓ api.zip present"
          else
            echo "✗ api.zip missing on ${TAG}" >&2
            exit 1
          fi

      - name: Verify api-tests.zip uploaded to Release (manual seed)
        if: (github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call') && inputs.release_tag != '' && steps.mode.outputs.mode == 'seed'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ inputs.release_tag }}
        run: |
          set -euo pipefail
          assets=$(curl -s -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/tags/${TAG}" | jq -r '.assets[].name // empty')
          echo "Assets on ${TAG}:"; echo "$assets" | sed 's/^/- /'
          if echo "$assets" | grep -qx 'api-tests.zip'; then
            echo "✓ api-tests.zip present"
          else
            echo "✗ api-tests.zip missing on ${TAG}" >&2
            exit 1
          fi

      - name: Debug seed context
        if: always() && github.event_name == 'workflow_dispatch'
        shell: bash
        run: |
          echo "ENVIRONMENT='(n/a - build-only)'"
          echo "RELEASE_TAG='${{ inputs.release_tag }}'"
          echo "MODE='${{ steps.mode.outputs.mode }}'"
          echo "PACKAGE_EXISTS='$([ -f "${{ env.PACKAGE }}" ] && echo yes || echo no)'"

