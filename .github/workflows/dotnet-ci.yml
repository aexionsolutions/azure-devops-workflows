name: Reusable .NET CI

on:
  workflow_call:
    inputs:
      git_ref:
        description: 'Git ref (tag/sha/branch) to test. Required for promote-release to ensure tests match the build version.'
        required: false
        type: string
      solution:
        required: true
        type: string
        default: TEMS.sln
      coverage_threshold:
        required: false
        type: number
        default: 80
      run_integration:
        required: false
        type: boolean
        default: false
      sonar_enabled:
        required: false
        type: boolean
        default: true
      pr_number:
        required: false
        type: string
        default: ''
      pr_head:
        required: false
        type: string
        default: ''
      pr_base:
        required: false
        type: string
        default: ''
      web_working_directory:
        required: false
        type: string
        description: 'Working directory for web unit tests (vitest)'
        default: 'web'
      run_web_unit_tests:
        required: false
        type: boolean
        description: 'Run web unit tests with vitest (skip if repo does not have vitest yet)'
        default: false
      enforce_coverage:
        required: false
        type: boolean
        description: 'Enforce coverage thresholds. Set to false for time-travel testing (e.g., promote-release) where coverage was already validated.'
        default: true
      coverage_assembly_filters:
        required: false
        type: string
        description: 'Assembly filters for code coverage (e.g., -MyApp.Tests;-MyApp.Infrastructure). Test assemblies are automatically excluded.'
        default: ''
    secrets:
      SONAR_TOKEN:
        required: false
      SONAR_ORG:
        required: false
      SONAR_PROJECT_KEY:
        required: false

jobs:
  ci:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    # Docker services for integration tests (PostgreSQL + Azurite)
    # These run ONLY when run_integration: true
    # Cost: $0 (included in GitHub Actions free tier)
    # Lifespan: Duration of test run (~2-3 minutes)
    # Network: Isolated to this runner (cannot access Azure)
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: test_password_123
          POSTGRES_DB: Tems_test
        ports:
          - 5432:5432
        # Health checks ensure PostgreSQL is ready before tests
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      azurite:
        image: mcr.microsoft.com/azure-storage/azurite:latest
        ports:
          - 10000:10000
          - 10001:10001
          - 10002:10002
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.git_ref || github.ref }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Detect SonarCloud
        id: sonar
        uses: aexionsolutions/azure-devops-workflows/.github/actions/sonar-detect@main
        with:
          requested: ${{ inputs.sonar_enabled }}
          token: ${{ secrets.SONAR_TOKEN }}
          org: ${{ secrets.SONAR_ORG }}
          projectKey: ${{ secrets.SONAR_PROJECT_KEY }}

      - name: Verify SonarCloud project readiness
        if: steps.sonar.outputs.enabled == 'true'
        id: sonar_ready
        shell: bash
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
        run: |
          set -e
          # Ensure project exists
          RESP=$(curl -s -u "$SONAR_TOKEN:" "https://sonarcloud.io/api/projects/search?projects=$SONAR_PROJECT_KEY" || echo "")
          if echo "$RESP" | grep -q '\"components\":\[\]'; then
            echo "### SonarCloud: Project '$SONAR_PROJECT_KEY' not found." >> "$GITHUB_STEP_SUMMARY"
            echo "Create the project in your SonarCloud organization, then re-run." >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi
          # Try to detect default branch; if uncertain, do not block
          BR=$(curl -s -u "$SONAR_TOKEN:" "https://sonarcloud.io/api/project_branches/list?project=$SONAR_PROJECT_KEY" || echo "")
          if echo "$BR" | jq -e '.branches | map(select(.isMain == true)) | length >= 1' >/dev/null 2>&1; then
            echo "ready=true" >> $GITHUB_OUTPUT
          else
            echo "ready=true" >> $GITHUB_OUTPUT
            echo "### SonarCloud: Could not confirm default branch via API – proceeding anyway. If analysis fails, verify default branch in Project Settings > Branches." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Install SonarScanner for .NET
        if: steps.sonar.outputs.enabled == 'true'
        uses: aexionsolutions/azure-devops-workflows/.github/actions/sonar-dotnet-begin@main
        with:
          token: ${{ secrets.SONAR_TOKEN }}
          org: ${{ secrets.SONAR_ORG }}
          projectKey: ${{ secrets.SONAR_PROJECT_KEY }}
          branch: ${{ github.ref_name }}
          pr_key: ${{ inputs.pr_number }}
          pr_branch: ${{ inputs.pr_head }}
          pr_base: ${{ inputs.pr_base }}
          js_lcov: tems-web/coverage/lcov.info

      # Sonar begin is handled by the composite above (conditionally)

      - name: Restore
        run: dotnet restore ${{ inputs.solution }}

      - name: Build
        run: dotnet build ${{ inputs.solution }} -c Release --no-restore

      - name: Unit Tests + Coverage (OpenCover)
        run: |
          echo "### Running Unit Tests (Fast Feedback)" >> "$GITHUB_STEP_SUMMARY"
          dotnet test tests/Ems.UnitTests/Ems.UnitTests.csproj \
            -c Release --no-build \
            --collect:"XPlat Code Coverage" \
            --logger "trx;LogFileName=unit.trx" \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
          
          # Coverage report generation (exclude test assemblies from coverage)
          dotnet tool install -g dotnet-reportgenerator-globaltool || true
          # Determine assembly filters (always exclude test assemblies + custom filters)
          # Auto-detect test assemblies by looking at test project names
          TEST_PROJECTS=$(find tests -name '*.csproj' 2>/dev/null | xargs -I {} basename {} .csproj | tr '\n' ';' | sed 's/;$//' | sed 's/;/;-/g')
          if [ -n "$TEST_PROJECTS" ]; then
            ASSEMBLY_FILTERS="-$TEST_PROJECTS"
          fi
          # Append custom filters if provided
          if [ -n "${{ inputs.coverage_assembly_filters }}" ]; then
            if [ -n "$ASSEMBLY_FILTERS" ]; then
              ASSEMBLY_FILTERS="$ASSEMBLY_FILTERS;${{ inputs.coverage_assembly_filters }}"
            else
              ASSEMBLY_FILTERS="${{ inputs.coverage_assembly_filters }}"
            fi
          fi
          
          reportgenerator \
            "-reports:**/coverage.opencover.xml" \
            "-targetdir:coverage-report" \
            "-reporttypes:TextSummary" \
            "-assemblyfilters:$ASSEMBLY_FILTERS"
          cat coverage-report/Summary.txt || true

      - name: Integration Tests + Coverage (OpenCover)
        if: inputs.run_integration == true
        env:
          # Connection string for Docker PostgreSQL service
          ConnectionStrings__DefaultConnection: "Host=localhost;Port=5432;Database=Tems_test;Username=postgres;Password=test_password_123"
        run: |
          echo "### Running Integration Tests (Database + HTTP)" >> "$GITHUB_STEP_SUMMARY"
          echo "Using Docker PostgreSQL service (ephemeral, isolated)" >> "$GITHUB_STEP_SUMMARY"
          
          # Verify PostgreSQL health before running tests (service health checks handle this, but double-check)
          echo "✅ PostgreSQL service ready (verified by service health checks)" >> "$GITHUB_STEP_SUMMARY"
          
          # Run integration tests with Docker PostgreSQL
          dotnet test tests/Ems.IntegrationTests/Ems.IntegrationTests.csproj \
            -c Release --no-build \
            --collect:"XPlat Code Coverage" \
            --logger "trx;LogFileName=integration.trx" \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
          
          echo "✅ Integration tests completed" >> "$GITHUB_STEP_SUMMARY"
      
      - name: Check coverage threshold
        id: coverage_check
        continue-on-error: true
        shell: bash
        run: |
          set -e
          # Re-generate summary to ensure we include all coverage files (unit + integration when enabled)
          dotnet tool install -g dotnet-reportgenerator-globaltool || true
          
          # Determine assembly filters (always exclude test assemblies + custom filters)
          # Auto-detect test assemblies by looking at test project names
          TEST_PROJECTS=$(find tests -name '*.csproj' 2>/dev/null | xargs -I {} basename {} .csproj | tr '\n' ';' | sed 's/;$//' | sed 's/;/;-/g')
          if [ -n "$TEST_PROJECTS" ]; then
            ASSEMBLY_FILTERS="-$TEST_PROJECTS"
          fi
          # Append custom filters if provided
          if [ -n "${{ inputs.coverage_assembly_filters }}" ]; then
            if [ -n "$ASSEMBLY_FILTERS" ]; then
              ASSEMBLY_FILTERS="$ASSEMBLY_FILTERS;${{ inputs.coverage_assembly_filters }}"
            else
              ASSEMBLY_FILTERS="${{ inputs.coverage_assembly_filters }}"
            fi
          fi
          
          reportgenerator \
            "-reports:**/coverage.opencover.xml" \
            "-targetdir:coverage-report" \
            "-reporttypes:TextSummary" \
            "-assemblyfilters:$ASSEMBLY_FILTERS" \
            "-classfilters:-*RegexGenerator*" \
            "-filefilters:-**/obj/**"

          if [ ! -f coverage-report/Summary.txt ]; then
            echo "Coverage summary not found; skipping enforcement." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          echo "### Coverage Gate" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          cat coverage-report/Summary.txt >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

          # Extract numeric percentage from the summary (e.g., "Line coverage: 82.3%")
          LINE_COV=$(grep -Eo 'Line coverage: [0-9]+(\.[0-9]+)?%' coverage-report/Summary.txt | grep -Eo '[0-9]+(\.[0-9]+)?' | head -n1)
          THRESHOLD=${{ inputs.coverage_threshold }}

          if [ -z "$LINE_COV" ]; then
            echo "Could not parse line coverage from Summary.txt" >&2
            cat coverage-report/Summary.txt
            exit 1
          fi

          echo "Coverage: ${LINE_COV}% | Threshold: ${THRESHOLD}%"
          
          if awk -v cov="$LINE_COV" -v thr="$THRESHOLD" 'BEGIN { exit ((cov+0) < (thr+0)) }'; then
            echo "✅ Coverage ${LINE_COV}% >= threshold ${THRESHOLD}%" >> "$GITHUB_STEP_SUMMARY"
            echo "COVERAGE_PASSED=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Coverage ${LINE_COV}% is below threshold ${THRESHOLD}%" >> "$GITHUB_STEP_SUMMARY"
            echo "::warning::Coverage ${LINE_COV}% is below threshold ${THRESHOLD}% - will fail after SonarCloud upload"
            echo "COVERAGE_PASSED=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      - name: Web unit tests + coverage (vitest)
        if: inputs.run_web_unit_tests == true
        working-directory: ${{ inputs.web_working_directory }}
        run: |
          rm -f package-lock.json
          npm install
          npm run test:ci

      - name: Upload web coverage artifact
        if: always() && inputs.run_web_unit_tests == true
        uses: actions/upload-artifact@v5
        with:
          name: web-coverage
          path: ${{ inputs.web_working_directory }}/coverage/**
          if-no-files-found: warn
          retention-days: 7

      - name: Debug coverage files for Sonar
        if: steps.sonar.outputs.enabled == 'true'
        shell: bash
        run: |
          shopt -s globstar || true
          COUNT=$(ls -1 **/coverage.opencover.xml 2>/dev/null | wc -l | tr -d ' ')
          echo "Found OpenCover files: ${COUNT:-0}"
          ls -1 **/coverage.opencover.xml 2>/dev/null | head -n 5 || true

      - name: SonarCloud End
        if: steps.sonar.outputs.enabled == 'true'
        uses: aexionsolutions/azure-devops-workflows/.github/actions/sonar-dotnet-end@main
        with:
          token: ${{ secrets.SONAR_TOKEN }}

      - name: Upload CI artifacts
        uses: actions/upload-artifact@v5
        with:
          name: dotnet-ci-artifacts
          path: |
            **/TestResults/**
            coverage-report/**
            **/coverage.cobertura.xml
          if-no-files-found: warn
          retention-days: 7

      - name: Detect code changes
        id: code_changes
        shell: bash
        run: |
          # Check if any actual code files changed (not just workflows/docs)
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} || echo "")
          CODE_CHANGED=false
          
          if echo "$CHANGED_FILES" | grep -qE '\.(cs|csproj|sln)$'; then
            CODE_CHANGED=true
            echo " Code files changed - coverage enforcement applies"
          else
            echo "ℹ No code files changed - skipping coverage enforcement"
          fi
          
          echo "CODE_CHANGED=$CODE_CHANGED" >> $GITHUB_OUTPUT
          echo "::notice::Code changed: $CODE_CHANGED"

      - name: Enforce coverage threshold (final)
        if: inputs.enforce_coverage == true && steps.coverage_check.outputs.COVERAGE_PASSED == 'false' && steps.code_changes.outputs.CODE_CHANGED == 'true'
        shell: bash
        run: |
          echo "::error::Coverage threshold not met - see coverage check step for details"
          exit 1

      - name: Summarize CI
        shell: bash
        run: |
          echo "## .NET CI Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "Branch: ${{ github.ref_name }}" >> "$GITHUB_STEP_SUMMARY"
          if [ -f coverage-report/Summary.txt ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### Coverage" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            cat coverage-report/Summary.txt >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
          fi
