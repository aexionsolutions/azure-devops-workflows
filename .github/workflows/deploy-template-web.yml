name: Template - Deploy Web (App Service)

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      app-name:
        required: true
        type: string
      resource-group:
        required: false
        type: string
        default: ''
      artifact-name:
        required: false
        type: string
        default: ''
      package:
        required: false
        type: string
        default: ''
      warmup-url-staging:
        required: false
        type: string
        default: ''
      warmup-url-prod:
        required: false
        type: string
        default: ''
      expect-version:
        required: false
        type: string
        default: ''
      version-url:
        required: false
        type: string
        default: ''
      run-from-package:
        required: false
        type: string
        default: 'true'
      verify-base-url:
        required: false
        type: string
        default: ''
      require-preprod-parity:
        required: false
        type: string
        default: 'false'
      preprod-version-url:
        required: false
        type: string
        default: ''
      workflow_version:
        required: false
        type: string
        description: 'Version/ref of azure-devops-workflows to use for actions (e.g., v4.0.1, fix/use-workflow-ref-for-actions)'
        default: ''
    secrets:
      AZURE_CLIENT_ID:
        required: false
      AZURE_TENANT_ID:
        required: false
      AZURE_SUBSCRIPTION_ID:
        required: false
      AZURE_CREDENTIALS:
        required: false
      B2C_TEST_USER_EMAIL:
        required: false
      B2C_TEST_USER_PASSWORD:
        required: false

permissions:
  id-token: write
  contents: read

jobs:
  deploy-staging:
    name: Deploy to Staging
    uses: ./.github/workflows/appservice-slot-deploy.yml
    with:
      environment: ${{ inputs.environment }}
      resource-group: ${{ inputs.resource-group }}
      app-name: ${{ inputs.app-name }}
      artifact-name: ${{ inputs.artifact-name }}
      package: ${{ inputs.package }}
      use-slot: auto
      warmup-url-staging: ${{ inputs.warmup-url-staging }}
      warmup-url-prod: ${{ inputs.warmup-url-prod }}
      skip-swap: 'true'
      run-from-package: ${{ inputs['run-from-package'] }}
      display-name: Deploy to Staging
    secrets: inherit

  parity-gate:
    name: Preprod parity gate
    runs-on: ubuntu-latest
    if: inputs.environment == 'prod' && inputs['require-preprod-parity'] == 'true'
    steps:
      - name: Check preprod version matches expected
        shell: bash
        env:
          EXPECT: ${{ inputs['expect-version'] }}
          URL: ${{ inputs['preprod-version-url'] }}
        run: |
          set -euo pipefail
          if [ -z "${EXPECT:-}" ] || [ -z "${URL:-}" ]; then
            echo "Parity gate misconfigured: expect-version or preprod-version-url missing" >&2
            exit 1
          fi
          echo "Checking $URL contains version $EXPECT"
          BODY=$(curl -fsSL --max-time 20 "$URL" || true)
          if ! echo "$BODY" | grep -q "$EXPECT"; then
            echo "Preprod parity check failed: expected $EXPECT not found in response" >&2
            exit 1
          fi

  verify-web:
    name: Verify Web Deployment
    needs: deploy-staging
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    outputs:
      base_url: ${{ steps.base.outputs.url }}
    steps:
      - name: Checkout repository (no token persisted)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Extract workflow ref
        id: workflow_ref
        shell: bash
        run: |
          if [ -n "${{ inputs.workflow_version }}" ]; then
            REF="${{ inputs.workflow_version }}"
          elif [ -n "${{ github.workflow_ref }}" ]; then
            WORKFLOW_REF="${{ github.workflow_ref }}"
            REF="${WORKFLOW_REF##*@}"
          else
            REF="main"
          fi
          echo "ref=$REF" >> $GITHUB_OUTPUT

      - name: Decide base URL
        id: base
        shell: bash
        env:
          ENV: ${{ inputs.environment }}
          PROVIDED: ${{ inputs['verify-base-url'] }}
          USE_SLOT: ${{ needs.deploy-staging.outputs.use_slot }}
        run: |
          if [ -n "$PROVIDED" ]; then echo "url=$PROVIDED" >> $GITHUB_OUTPUT; exit 0; fi
          if [ "$USE_SLOT" = "true" ]; then
            echo "url=https://tems-${ENV}-web-staging.azurewebsites.net" >> $GITHUB_OUTPUT
          else
            echo "url=https://tems-${ENV}-web.azurewebsites.net" >> $GITHUB_OUTPUT
          fi

      - name: Web smoke (Playwright)
        uses: aexionsolutions/azure-devops-workflows/.github/actions/playwright-smoke@${{ steps.workflow_ref.outputs.ref }}
        env:
          B2C_TEST_USER_EMAIL: ${{ secrets.B2C_TEST_USER_EMAIL }}
          B2C_TEST_USER_PASSWORD: ${{ secrets.B2C_TEST_USER_PASSWORD }}
        with:
          base-url: ${{ steps.base.outputs.url }}
          artifact-name: web-playwright-${{ inputs.environment }}
          run-auth-smoke: 'true'

  route-traffic:
    name: Deploy to Production
    needs: [deploy-staging, verify-web, parity-gate]
    if: |
      always() &&
      (needs.verify-web.result == 'success') &&
      (inputs.environment != 'prod' || inputs['require-preprod-parity'] != 'true' || needs.parity-gate.result == 'success')
    uses: ./.github/workflows/appservice-slot-deploy.yml
    with:
      environment: ${{ inputs.environment }}
      resource-group: ${{ inputs.resource-group }}
      app-name: ${{ inputs.app-name }}
      artifact-name: ${{ inputs.artifact-name }}
      package: ${{ inputs.package }}
      use-slot: auto
      warmup-url-staging: ${{ inputs.warmup-url-staging }}
      warmup-url-prod: ${{ inputs.warmup-url-prod }}
      skip-deploy: 'true'
      expect-version: ${{ inputs['expect-version'] }}
      version-url: ${{ inputs['version-url'] }}
      run-from-package: ${{ inputs['run-from-package'] }}
      display-name: Deploy to Production
    secrets: inherit

  verify-summary:
    name: Verify Failure Summary
    needs: [verify-web]
    if: always() && (needs.verify-web.result == 'failure')
    runs-on: ubuntu-latest
    steps:
      - name: Write verify failure summary
        shell: bash
        env:
          URL_WEB: ${{ needs.verify-web.outputs.base_url }}
        run: |
          {
            echo "## âŒ Verification Failed"
            echo ""
            echo "**Web URL:** $URL_WEB"
            echo ""
            echo "See step logs above for details."
          } >> "$GITHUB_STEP_SUMMARY"
