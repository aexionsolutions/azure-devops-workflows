name: Web Build (Artifact Only)
# NOTE: Environment deployments are centralized in promote-release.yml.
# This workflow builds and packages web.zip only (build or manual seed to a release tag).

on:
  workflow_call:
    inputs:
      git_ref:
        description: 'Tag or commit SHA (empty = HEAD)'
        required: false
        type: string
        default: ''
      release_tag:
        description: 'Optional: Release tag (e.g., v1.2.3). If set, build and attach web.zip to that tag (seed).'
        required: false
        type: string
        default: ''
      allow_override:
        description: 'Allow replacing existing web.zip on the release (only when not LOCKED)'
        type: boolean
        required: false
        default: false
      web_directory:
        description: 'Path to web project directory (e.g., web/tems-portal)'
        required: true
        type: string
        
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      git_ref:
        description: 'Tag or commit SHA (empty = HEAD)'
        required: false
        default: ''
      release_tag:
        description: 'Optional: Release tag (e.g., v1.2.3). If set, build and attach web.zip to that tag (seed).'
        required: false
        default: ''
      allow_override:
        description: 'Allow replacing existing web.zip on the release (only when not LOCKED)'
        type: boolean
        required: false
        default: false
      web_directory:
        description: 'Path to web project directory (e.g., web/tems-portal)'
        required: true
        type: string
        
  # All automated triggers are orchestrated from main-verify.yml via workflow_dispatch

concurrency:
  # Single build concurrency group; environment deployments moved to promote-release.yml
  group: tems-web-build
  cancel-in-progress: true

permissions:
  id-token: write
  contents: write

jobs:
  # Note: Environment deploy steps removed. Use promote-release.yml for dev/uat/preprod/prod.
  build-and-package:
    name: Build & Package
    runs-on: windows-latest
    # Build for tag pushes (to create durable release assets) OR any manual run
    if: (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) || github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call'
    env:
      PACKAGE: web.zip
    outputs:
      version: ${{ steps.export.outputs.version }}

    steps:
      - name: Debug trigger context
        if: always()
        shell: bash
        run: |
          echo "Event:               ${{ github.event_name }}"
          echo "Repo default_branch: ${{ github.event.repository.default_branch }}"
          echo "Ref:                 ${{ github.ref }}"
          echo "Inputs.release_tag:  ${{ inputs.release_tag }}"

      - name: Checkout repository (no token persisted)
        if: github.event_name != 'pull_request'
        uses: actions/checkout@v4	
        with:
          fetch-depth: 0
          ref: ${{ inputs.git_ref || '' }}
          persist-credentials: false

      - uses: actions/setup-node@v4
        with: { node-version: '20' }

      - name: Derive version
        id: derive_version
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ github.ref_type }}" = "tag" ]; then
            VERSION="${{ github.ref_name }}"
          elif [ -n "${{ inputs.release_tag }}" ]; then
            VERSION="${{ inputs.release_tag }}"
          else
            VERSION="0.0.0-dev"
          fi
          # Strip 'v' prefix if present (v0.1.0 → 0.1.0)
          VERSION="${VERSION#v}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Derived version: $VERSION"

      - name: Determine seed mode
        id: mode
        shell: bash
        env:
          RELEASE_TAG: ${{ inputs.release_tag }}
          EV: ${{ github.event_name }}
        run: |
          set -euo pipefail
          if { [ "$EV" = "workflow_dispatch" ] || [ "$EV" = "workflow_call" ]; } && [ -n "${RELEASE_TAG:-}" ]; then
            echo "mode=seed" >> $GITHUB_OUTPUT
            echo "Seed mode (build + attach to $RELEASE_TAG)" >> $GITHUB_STEP_SUMMARY
          else
            echo "mode=build" >> $GITHUB_OUTPUT
            echo "Build mode (artifact only)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Install, Lint, Test, Build
        if: steps.mode.outputs.mode == 'build' || steps.mode.outputs.mode == 'seed'
        working-directory: ${{ inputs.web_directory || 'web/tems-portal' }}
        shell: bash
        run: |
          npm ci || npm i
            # Skip lint and test during artifact build (run in CI workflows instead)
            # npm run lint --if-present
            # npm test --if-present
            npm run build

      - name: Install Playwright browsers
        if: steps.mode.outputs.mode == 'build' || steps.mode.outputs.mode == 'seed'
        shell: bash
        run: |
          # Install Playwright browsers with OS-appropriate flags
          if [ "$RUNNER_OS" = "Linux" ]; then
            npx playwright install --with-deps chromium || true
          else
            npx playwright install chromium || true
          fi

      - name: "Package web (slim zip: standalone)"
        if: steps.mode.outputs.mode == 'build' || steps.mode.outputs.mode == 'seed'
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force _webpkg -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Path _webpkg | Out-Null
          
          # Copy standalone output as the base
          Copy-Item -Recurse ${{ inputs.web_directory || 'web/tems-portal' }}/.next/standalone/* _webpkg/
          
          # Rename Next.js's server.js to next-server.js so we can use our custom launcher
          Move-Item _webpkg/server.js _webpkg/next-server.js -Force
          
          # Copy our custom launcher as server.js
          Copy-Item ${{ inputs.web_directory || 'web/tems-portal' }}/server.js _webpkg/server.js -Force
          Copy-Item ${{ inputs.web_directory || 'web/tems-portal' }}/web.config _webpkg/web.config -Force
          
          # Copy static assets into .next/static (required for standalone)
          New-Item -ItemType Directory -Path _webpkg/.next/static -Force | Out-Null
          if (Test-Path ${{ inputs.web_directory || 'web/tems-portal' }}/.next/static) { Copy-Item -Recurse ${{ inputs.web_directory || 'web/tems-portal' }}/.next/static/* _webpkg/.next/static/ }
          
          # Copy public folder to root
          if (Test-Path ${{ inputs.web_directory || 'web/tems-portal' }}/public) { Copy-Item -Recurse ${{ inputs.web_directory || 'web/tems-portal' }}/public _webpkg/public }
          
          if (Test-Path $env:PACKAGE) { Remove-Item $env:PACKAGE -Force }
          Compress-Archive -Path _webpkg/* -DestinationPath $env:PACKAGE -CompressionLevel Optimal

      - name: Upload web package artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: web-package
          path: ${{ env.PACKAGE }}
          if-no-files-found: warn
          retention-days: 7

      - name: Package Web tests (archive)
        if: steps.mode.outputs.mode == 'build' || steps.mode.outputs.mode == 'seed'
        shell: pwsh
        run: |
          if (Test-Path web-tests.zip) { Remove-Item web-tests.zip -Force }
          $items = @(
            '${{ inputs.web_directory || 'web/tems-portal' }}/tests',
            '${{ inputs.web_directory || 'web/tems-portal' }}/vitest.config.mts',
            '${{ inputs.web_directory || 'web/tems-portal' }}/vitest.setup.mts',
            '${{ inputs.web_directory || 'web/tems-portal' }}/vitest.env.d.ts',
            '${{ inputs.web_directory || 'web/tems-portal' }}/package.json',
            '${{ inputs.web_directory || 'web/tems-portal' }}/package-lock.json',
            '${{ inputs.web_directory || 'web/tems-portal' }}/pnpm-lock.yaml',
            '${{ inputs.web_directory || 'web/tems-portal' }}/tsconfig.json'
          )
          $existing = $items | Where-Object { Test-Path $_ }
          if ($existing.Count -eq 0) { New-Item -ItemType File -Path __empty_tests_marker.txt | Out-Null; $existing = @('__empty_tests_marker.txt') }
          Compress-Archive -Path $existing -DestinationPath web-tests.zip -CompressionLevel Optimal

      - name: Export deploy inputs
        id: export
        shell: bash
        run: |
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
      - name: Attach web.zip to Release (tag build)
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.export.outputs.version }}
          name: ${{ steps.export.outputs.version }}
          files: ${{ env.PACKAGE }}

      - name: Attach web-tests.zip to Release (tag build)
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.export.outputs.version }}
          name: ${{ steps.export.outputs.version }}
          files: web-tests.zip

      - name: Inspect release state (seed)
        if: (github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call') && inputs.release_tag != '' && steps.mode.outputs.mode == 'seed'
        id: rel
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ inputs.release_tag }}
        run: |
          set -euo pipefail
          api="https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/tags/${TAG}"
          json=$(curl -s -H "Authorization: token $GH_TOKEN" "$api")
          body=$(echo "$json" | jq -r '.body // ""')
          if echo "$body" | grep -q '<!-- LOCKED -->'; then echo "locked=true" >> $GITHUB_OUTPUT; else echo "locked=false" >> $GITHUB_OUTPUT; fi
          id=$(echo "$json" | jq -r '.assets[] | select(.name=="web.zip") | .id' | head -n1)
          if [ -n "$id" ] && [ "$id" != "null" ]; then echo "has_asset=true" >> $GITHUB_OUTPUT; echo "asset_id=$id" >> $GITHUB_OUTPUT; else echo "has_asset=false" >> $GITHUB_OUTPUT; fi
          id2=$(echo "$json" | jq -r '.assets[] | select(.name=="web-tests.zip") | .id' | head -n1)
          if [ -n "$id2" ] && [ "$id2" != "null" ]; then echo "has_tests=true" >> $GITHUB_OUTPUT; echo "tests_asset_id=$id2" >> $GITHUB_OUTPUT; else echo "has_tests=false" >> $GITHUB_OUTPUT; fi

      - name: Delete existing web.zip (override)
        if: (github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call') && inputs.release_tag != '' && steps.mode.outputs.mode == 'seed' && inputs.allow_override == true && steps.rel.outputs.locked != 'true' && steps.rel.outputs.has_asset == 'true'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ASSET_ID: ${{ steps.rel.outputs.asset_id }}
        run: |
          set -euo pipefail
          curl -s -X DELETE -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/assets/${ASSET_ID}" | cat

      - name: Delete existing web-tests.zip (override)
        if: (github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call') && inputs.release_tag != '' && steps.mode.outputs.mode == 'seed' && inputs.allow_override == true && steps.rel.outputs.locked != 'true' && steps.rel.outputs.has_tests == 'true'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ASSET_ID: ${{ steps.rel.outputs.tests_asset_id }}
        run: |
          set -euo pipefail
          curl -s -X DELETE -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/assets/${ASSET_ID}" | cat

      - name: Attach web.zip to Release (manual seed)
        if: (github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call') && inputs.release_tag != '' && steps.mode.outputs.mode == 'seed' && steps.rel.outputs.locked != 'true'
        continue-on-error: true
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.release_tag }}
          name: ${{ inputs.release_tag }}
          files: ${{ env.PACKAGE }}

      - name: Attach web-tests.zip to Release (manual seed)
        if: (github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call') && inputs.release_tag != '' && steps.mode.outputs.mode == 'seed' && steps.rel.outputs.locked != 'true'
        continue-on-error: true
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.release_tag }}
          name: ${{ inputs.release_tag }}
          files: web-tests.zip

      - name: Fallback attach via GitHub API (if missing)
        if: (github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call') && inputs.release_tag != '' && steps.mode.outputs.mode == 'seed' && steps.rel.outputs.locked != 'true'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ inputs.release_tag }}
          FILE: ${{ env.PACKAGE }}
        run: |
          set -euo pipefail
          api="https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/tags/${TAG}"
          json=$(curl -s -H "Authorization: token $GH_TOKEN" "$api")
          # Check if asset already present
          names=$(echo "$json" | jq -r '.assets[].name // empty')
          if echo "$names" | grep -qx 'web.zip'; then
            echo "web.zip already present on $TAG; skipping fallback upload."
            exit 0
          fi
          upload_url=$(echo "$json" | jq -r '.upload_url' | sed 's/{?name,label}//')
          if [ -z "$upload_url" ] || [ "$upload_url" = "null" ]; then
            echo "Unable to resolve upload_url for $TAG" >&2
            exit 1
          fi
          echo "Uploading web.zip via REST API..."
          curl -s -X POST -H "Authorization: token $GH_TOKEN" \
               -H "Content-Type: application/zip" \
               --data-binary @"$FILE" \
               "$upload_url?name=web.zip" >/dev/null
          # verify
          json2=$(curl -s -H "Authorization: token $GH_TOKEN" "$api")
          names2=$(echo "$json2" | jq -r '.assets[].name // empty')
          if echo "$names2" | grep -qx 'web.zip'; then
            echo "web.zip attached successfully via fallback."
          else
            echo "Fallback upload did not attach web.zip" >&2
            exit 1
          fi

      - name: Verify web.zip uploaded to Release (manual seed)
        if: (github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call') && inputs.release_tag != '' && steps.mode.outputs.mode == 'seed'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ inputs.release_tag }}
        run: |
          set -euo pipefail
          assets=$(curl -s -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/tags/${TAG}" | jq -r '.assets[].name // empty')
          echo "Assets on ${TAG}:"; echo "$assets" | sed 's/^/- /'
          if echo "$assets" | grep -qx 'web.zip'; then
            echo "✓ web.zip present"
          else
            echo "✗ web.zip missing on ${TAG}" >&2
            exit 1
          fi

      - name: Verify web-tests.zip uploaded to Release (manual seed)
        if: (github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call') && inputs.release_tag != '' && steps.mode.outputs.mode == 'seed'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ inputs.release_tag }}
        run: |
          set -euo pipefail
          assets=$(curl -s -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/tags/${TAG}" | jq -r '.assets[].name // empty')
          echo "Assets on ${TAG}:"; echo "$assets" | sed 's/^/- /'
          if echo "$assets" | grep -qx 'web-tests.zip'; then
            echo "✓ web-tests.zip present"
          else
            echo "✗ web-tests.zip missing on ${TAG}" >&2
            exit 1
          fi

  # Environment deploy & preprod gate logic removed; handled centrally in promote-release.yml
