name: Version Tagging

# Auto-generate version tags based on conventional commits
# - Pre-release tags on PR creation (v3.2.0-pr.123)
# - Stable tags on merge to main (v3.2.0)

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  # Generate pre-release tag when PR is created/updated
  prerelease-tag:
    name: Generate Pre-release Tag
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    outputs:
      prerelease_tag: ${{ steps.version.outputs.prerelease_tag }}
      bump_type: ${{ steps.version.outputs.bump_type }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for version detection
          
      - name: Detect version from conventional commits
        id: version
        shell: bash
        run: |
          # Get the last version tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          echo "Last tag: $LAST_TAG"
          
          # Parse version (remove 'v' prefix)
          VERSION=${LAST_TAG#v}
          IFS='.' read -ra VER <<< "$VERSION"
          MAJOR=${VER[0]}
          MINOR=${VER[1]}
          PATCH=${VER[2]}
          
          # Analyze commits since last tag to determine bump type
          # EXCLUDE commits with [skip version] marker or from github-actions bot
          COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"%s|%an" 2>/dev/null || git log --pretty=format:"%s|%an")
          COMMITS=$(echo "$COMMITS" | grep -v "\[skip version\]" | grep -v "github-actions\[bot\]" || echo "")
          COMMIT_MESSAGES=$(echo "$COMMITS" | cut -d'|' -f1)
          
          # Check for breaking changes
          if echo "$COMMIT_MESSAGES" | grep -qiE "^(feat|fix|chore|docs|refactor|perf|test|build|ci|style)(\(.+\))?!:" || \
             echo "$COMMIT_MESSAGES" | grep -qiE "BREAKING CHANGE:"; then
            # Major version bump
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            BUMP_TYPE="major"
          # Check for new features
          elif echo "$COMMIT_MESSAGES" | grep -qiE "^feat(\(.+\))?:"; then
            # Minor version bump
            MINOR=$((MINOR + 1))
            PATCH=0
            BUMP_TYPE="minor"
          # Check for fixes
          elif echo "$COMMIT_MESSAGES" | grep -qiE "^(fix|perf|refactor|chore)(\(.+\))?:"; then
            # Patch version bump
            PATCH=$((PATCH + 1))
            BUMP_TYPE="patch"
          else
            # No version bump (non-conventional commits)
            BUMP_TYPE="none"
          fi
          
          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          SHORT_SHA=$(git rev-parse --short HEAD)
          PRERELEASE_TAG="v${NEW_VERSION}-pr.${PR_NUMBER}.${SHORT_SHA}"
          
          echo "version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "prerelease_tag=${PRERELEASE_TAG}" >> $GITHUB_OUTPUT
          echo "bump_type=${BUMP_TYPE}" >> $GITHUB_OUTPUT
          
          echo "üì¶ Next version: v${NEW_VERSION}"
          echo "üè∑Ô∏è  Pre-release tag: ${PRERELEASE_TAG}"
          echo "‚¨ÜÔ∏è  Bump type: ${BUMP_TYPE}"
          
      - name: Create/Update Pre-release Tag
        if: steps.version.outputs.bump_type != 'none'
        shell: bash
        run: |
          TAG="${{ steps.version.outputs.prerelease_tag }}"
          
          # Configure git identity
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Delete existing pre-release tags for this PR
          PR_NUMBER="${{ github.event.pull_request.number }}"
          EXISTING_TAGS=$(git tag -l "v*-pr.${PR_NUMBER}.*")
          for OLD_TAG in $EXISTING_TAGS; do
            echo "üóëÔ∏è  Deleting old tag: $OLD_TAG"
            git tag -d "$OLD_TAG" || true
            git push origin ":refs/tags/$OLD_TAG" || true
          done
          
          # Create new pre-release tag
          echo "‚ú® Creating pre-release tag: $TAG"
          git tag -a "$TAG" -m "Pre-release for PR #$PR_NUMBER"
          git push origin "$TAG"
          
      - name: Comment on PR
        if: steps.version.outputs.bump_type != 'none'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tag = '${{ steps.version.outputs.prerelease_tag }}';
            const version = '${{ steps.version.outputs.version }}';
            const bumpType = '${{ steps.version.outputs.bump_type }}';
            
            const body = `## üì¶ Pre-release Tag Created
            
            **Tag:** \`${tag}\`
            **Next Version:** \`v${version}\`
            **Bump Type:** \`${bumpType}\`
            
            ### üß™ Test this pre-release in calling repos:
            
            \`\`\`yaml
            uses: aexionsolutions/azure-devops-workflows/.github/workflows/dotnet-ci.yml@${tag}
            \`\`\`
            
            ### ‚ÑπÔ∏è Version Detection
            - Based on [Conventional Commits](https://www.conventionalcommits.org/)
            - **Breaking changes** (\`feat!:\`, \`BREAKING CHANGE:\`) ‚Üí Major bump
            - **New features** (\`feat:\`) ‚Üí Minor bump
            - **Fixes/improvements** (\`fix:\`, \`chore:\`) ‚Üí Patch bump
            
            ---
            
            Once this PR is merged to \`main\`, the stable tag \`v${version}\` will be created automatically.`;
            
            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('Pre-release Tag Created')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # Pin internal action references to prerelease tag
  pin-prerelease:
    name: Pin Internal Actions to Pre-release
    runs-on: ubuntu-latest
    needs: prerelease-tag
    if: github.event_name == 'pull_request' && needs.prerelease-tag.outputs.bump_type != 'none' && github.event.pull_request.head.repo.full_name == github.repository
    permissions:
      contents: write
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
          
      - name: Wait for tag to be visible
        shell: bash
        run: |
          TAG="${{ needs.prerelease-tag.outputs.prerelease_tag }}"
          echo "‚è≥ Waiting for tag $TAG to be available..."
          
          for i in {1..10}; do
            git fetch --tags
            if git rev-parse "$TAG" >/dev/null 2>&1; then
              echo "‚úÖ Tag $TAG is visible"
              break
            fi
            echo "Attempt $i: Tag not yet visible, waiting..."
            sleep 2
          done
          
      - name: Pin action references
        shell: bash
        run: |
          TAG="${{ needs.prerelease-tag.outputs.prerelease_tag }}"
          echo "üìå Pinning internal actions to: $TAG"
          
          # Replace action references explicitly (only known actions)
          # Use safer pattern to preserve inline comments and prevent overmatch
          for file in .github/workflows/*.yml; do
            sed -i \
              -e "s|\(uses: aexionsolutions/azure-devops-workflows/.github/actions/sonar-detect\)@[^[:space:]]*|\1@$TAG|g" \
              -e "s|\(uses: aexionsolutions/azure-devops-workflows/.github/actions/sonar-dotnet-begin\)@[^[:space:]]*|\1@$TAG|g" \
              -e "s|\(uses: aexionsolutions/azure-devops-workflows/.github/actions/sonar-dotnet-end\)@[^[:space:]]*|\1@$TAG|g" \
              -e "s|\(uses: aexionsolutions/azure-devops-workflows/.github/actions/azure-login-smart\)@[^[:space:]]*|\1@$TAG|g" \
              -e "s|\(uses: aexionsolutions/azure-devops-workflows/.github/actions/resolve-rg\)@[^[:space:]]*|\1@$TAG|g" \
              -e "s|\(uses: aexionsolutions/azure-devops-workflows/.github/actions/appservice-slot-deploy\)@[^[:space:]]*|\1@$TAG|g" \
              -e "s|\(uses: aexionsolutions/azure-devops-workflows/.github/actions/playwright-smoke\)@[^[:space:]]*|\1@$TAG|g" \
              "$file"
          done
          
      - name: Commit changes
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git add .github/workflows/*.yml
          git commit -m "chore(pin): align internal actions to ${{ needs.prerelease-tag.outputs.prerelease_tag }} [skip version]"
          git push origin HEAD:${{ github.event.pull_request.head.ref }}
    outputs:
      prerelease_tag: ${{ needs.prerelease-tag.outputs.prerelease_tag }}

  # Generate stable release tag when merged to main
  release-tag:
    name: Generate Release Tag
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && github.actor != 'github-actions[bot]'
    outputs:
      tag: ${{ steps.version.outputs.tag }}
      bump_type: ${{ steps.version.outputs.bump_type }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Detect version from conventional commits
        id: version
        shell: bash
        run: |
          # Get the last version tag
          LAST_TAG=$(git describe --tags --abbrev=0 --match="v[0-9]*.[0-9]*.[0-9]*" 2>/dev/null || echo "v1.0.0")
          echo "Last stable tag: $LAST_TAG"
          
          # Parse version
          VERSION=${LAST_TAG#v}
          IFS='.' read -ra VER <<< "$VERSION"
          MAJOR=${VER[0]}
          MINOR=${VER[1]}
          PATCH=${VER[2]}
          
          # Analyze commits since last tag
          # EXCLUDE commits with [skip version] marker or from github-actions bot
          COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"%s|%an" 2>/dev/null || git log --pretty=format:"%s|%an")
          COMMITS=$(echo "$COMMITS" | grep -v "\[skip version\]" | grep -v "github-actions\[bot\]" || echo "")
          COMMIT_MESSAGES=$(echo "$COMMITS" | cut -d'|' -f1)
          
          # Determine version bump
          if echo "$COMMIT_MESSAGES" | grep -qiE "^(feat|fix|chore|docs|refactor|perf|test|build|ci|style)(\(.+\))?!:" || \
             echo "$COMMIT_MESSAGES" | grep -qiE "BREAKING CHANGE:"; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            BUMP_TYPE="major"
          elif echo "$COMMIT_MESSAGES" | grep -qiE "^feat(\(.+\))?:"; then
            MINOR=$((MINOR + 1))
            PATCH=0
            BUMP_TYPE="minor"
          elif echo "$COMMIT_MESSAGES" | grep -qiE "^(fix|perf|refactor|chore)(\(.+\))?:"; then
            PATCH=$((PATCH + 1))
            BUMP_TYPE="patch"
          else
            BUMP_TYPE="none"
            echo "‚ö†Ô∏è No conventional commits found - skipping tag"
          fi
          
          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          NEW_TAG="v${NEW_VERSION}"
          
          echo "version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${NEW_TAG}" >> $GITHUB_OUTPUT
          echo "bump_type=${BUMP_TYPE}" >> $GITHUB_OUTPUT
          
          echo "üì¶ New stable version: ${NEW_TAG}"
          echo "‚¨ÜÔ∏è  Bump type: ${BUMP_TYPE}"
          
      - name: Create Release Tag
        if: steps.version.outputs.bump_type != 'none'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          
          # Check if tag already exists
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è Tag $TAG already exists - skipping"
            exit 0
          fi
          
          # Extract changelog for this version
          CHANGELOG=""
          if [ -f "CHANGELOG.md" ]; then
            CHANGELOG=$(sed -n "/## \[Unreleased\]/,/## \[/p" CHANGELOG.md | sed '1d;$d' || echo "")
          fi
          
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="See [CHANGELOG.md](CHANGELOG.md) for details."
          fi
          
          # Create annotated tag
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
          
          echo "‚úÖ Created and pushed tag: $TAG"
          
          # Create GitHub Release
          gh release create "$TAG" \
            --title "Release $TAG" \
            --notes "$CHANGELOG" \
            --verify-tag
          
          echo "‚úÖ Created GitHub Release: $TAG"

  # Cleanup old pre-release tags (keep last 5 per PR)
  cleanup-prereleases:
    name: Cleanup Old Pre-release Tags
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && github.actor != 'github-actions[bot]'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Remove old pre-release tags
        shell: bash
        run: |
          echo "üßπ Cleaning up old pre-release tags..."
          
          # Get all pre-release tags
          PRERELEASE_TAGS=$(git tag -l "v*-pr.*" | sort -V)
          
          # Group by PR number and keep only latest 5 per PR
          for PR_TAG in $PRERELEASE_TAGS; do
            if [[ $PR_TAG =~ v[0-9]+\.[0-9]+\.[0-9]+-pr\.([0-9]+)\. ]]; then
              PR_NUM="${BASH_REMATCH[1]}"
              
              # Get all tags for this PR
              PR_TAGS=$(git tag -l "v*-pr.${PR_NUM}.*" | sort -V)
              TAG_COUNT=$(echo "$PR_TAGS" | wc -l)
              
              # Keep only last 5
              if [ $TAG_COUNT -gt 5 ]; then
                TO_DELETE=$(echo "$PR_TAGS" | head -n $((TAG_COUNT - 5)))
                for DEL_TAG in $TO_DELETE; do
                  echo "üóëÔ∏è  Deleting old tag: $DEL_TAG"
                  git push origin ":refs/tags/$DEL_TAG" || true
                done
              fi
            fi
          done
          
          echo "‚úÖ Cleanup complete"

  # Pin internal action references to stable release tag
  pin-stable:
    name: Pin Internal Actions to Stable Release
    runs-on: ubuntu-latest
    needs: release-tag
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.release-tag.outputs.bump_type != 'none'
    permissions:
      contents: write
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          
      - name: Pin action references
        shell: bash
        run: |
          TAG="${{ needs.release-tag.outputs.tag }}"
          echo "üìå Pinning internal actions to: $TAG"
          
          # Replace action references explicitly (only known actions)
          # Use safer pattern to preserve inline comments and prevent overmatch
          for file in .github/workflows/*.yml; do
            sed -i \
              -e "s|\(uses: aexionsolutions/azure-devops-workflows/.github/actions/sonar-detect\)@[^[:space:]]*|\1@$TAG|g" \
              -e "s|\(uses: aexionsolutions/azure-devops-workflows/.github/actions/sonar-dotnet-begin\)@[^[:space:]]*|\1@$TAG|g" \
              -e "s|\(uses: aexionsolutions/azure-devops-workflows/.github/actions/sonar-dotnet-end\)@[^[:space:]]*|\1@$TAG|g" \
              -e "s|\(uses: aexionsolutions/azure-devops-workflows/.github/actions/azure-login-smart\)@[^[:space:]]*|\1@$TAG|g" \
              -e "s|\(uses: aexionsolutions/azure-devops-workflows/.github/actions/resolve-rg\)@[^[:space:]]*|\1@$TAG|g" \
              -e "s|\(uses: aexionsolutions/azure-devops-workflows/.github/actions/appservice-slot-deploy\)@[^[:space:]]*|\1@$TAG|g" \
              -e "s|\(uses: aexionsolutions/azure-devops-workflows/.github/actions/playwright-smoke\)@[^[:space:]]*|\1@$TAG|g" \
              "$file"
          done
          
      - name: Commit and push
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git add .github/workflows/*.yml
          git commit -m "chore(pin): align internal actions to ${{ needs.release-tag.outputs.tag }} [skip version]"
          git push
